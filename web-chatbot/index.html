<!DOCTYPE html>
<link lang="en">
<link>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css"></link>
    <link rel="icon" href="./assets/images/favicon.png"></link>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Neosperience Chatbot</title>
    
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo"></div>
        </div>
    </header>

    <div class="chat-bg" id="chat-bg">
        <div class="typewriter">
            <h1>Welcome to the Neosperience Chatbot. Start typing below!</h1>
        </div>
        <div id="chat-body" class="container chat-body"></div>
    </div>

    <form class="input-container" autocomplete="off">
        <div class="container">
            <div class="gradient-border">
                <input 
                    type="text" 
                    id="text" 
                    placeholder="Type a message..."
                />
            </div>
            <div class="gradient-border">
                <button class="button" id="submit-button">
                    <img src="./assets/images/arrow.svg" alt="Send icon" height="20" width="20" class="send-icon" />
                </button>
            </div>
        </div>
    </form>
    <audio id="my_audio" src="./assets/audio/bg-audio.mp3" loop="loop"></audio>
    <img s
</body>
</html>
<script>

    $(document).ready(function() {
        // Declare URL to call
        const url = "https://66mlkwpffi.execute-api.us-east-1.amazonaws.com/dev";
        // List to keep track of past user inputs
        let pastUserInputs = []
        // List to keep track of past generated responses
        let generatedResponses = []
        // Last response generated by chatbot
        let lastResponse = "";
        // Input term written by the user
        let term;

        // Dictionary to map characters to escape
        var entityMap = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '/': '&#x2F;',
            '`': '&#x60;',
            '=': '&#x3D;'
        };

        // Escape HTML
        function escapeHtml (string) {
            return String(string).replace(/[&<>"'`=\/]/g, function (s) {
                return entityMap[s];
            });
        }
        
        // Function used to call the API
        async function sendMessage(url='', obj={}) {
            setTimeout(() => {
                createChatBubble("<div class='dot-typing'></div>", "bot", true, true)
            }, 1000);
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(obj)
            }).then(function(response) {
                // The response is a Response instance.
                // You parse the data into a useable format using `.json()`
                $("#chat-bg").animate({scrollTop: $("#chat-bg")[0].scrollHeight})
                console.log("Reponse" + JSON.stringify(response))
                return response.json();
            }).then(function(data) {
                // `data` is the parsed version of the JSON returned from the above endpoint.
                console.log("Data: " + JSON.parse(data.body).conversation.past_user_inputs)
                let r = JSON.parse(data.body);
                console.log("Res body " + r)

                    // Update the fields
                pastUserInputs = r.conversation.past_user_inputs;
                generatedResponses = r.conversation.generated_responses;
                lastResponse = r.generated_text;
                // When we have the response, put it in the UI
                $(".fixed").text(lastResponse);
                // Remove fixed class
                $("div").removeClass("fixed");
            })
        }

        // Given the text, owner and a bool as inputs, create the message bubble
        function createChatBubble(text, owner, fixed=false, last=false) {
            let now = new Date();
            let minutes = now.getMinutes();
            let hours = now.getHours();
            $(".chat-body").append(`
            <div class="message-picture ${owner === "user" ? "my-message" : "bot-message"}" id="${last ? "last" : ""}">
                <div class='${owner === "user" ? "my-message" : "bot-message"} ${fixed ? "fixed " : ""}message'>
                    <p>${owner === "user" ? escapeHtml(text) : text}</p>
                </div>
                ${owner === "user" ? "": '<div class="profile-picture" ></div>'}
            </div>
            `);
        }

        // Clears red border when focusing again on input
        $("#text").focus(function() {
            $(this).removeClass("error");
        })

        // Handle the submit of the input function
        $("#submit-button").click(function(event) {
            // Prevent default behaviour
            event.preventDefault();
            // Hide typewriting
            $(".typewriter").hide()
            // Get input value
            term = $("#text").val();
            // Logic when the input is valid (not empty)
            if (term.trim() !== "") {
                // Add bubble with entered text
                createChatBubble(term, "user");
                // $("#chat-bg").scrollTop($("#chat-bg")[0].scrollHeight);
                $("#chat-bg").animate({scrollTop: $("#chat-bg")[0].scrollHeight})
                // Reset the input text
                $("#text").val("");

                // Prepare the object to send
                const objToSend = {
                    string: {
                        inputs: {
                            past_user_inputs: pastUserInputs,
                            generated_responses: generatedResponses,
                            text: term
                        }
                    }
                }
                // While the request is being processed disable the input
                $("#text").prop("disabled", true);

                console.log(objToSend)
                // Get the data
                sendMessage(url, objToSend)
                
                // Enable the input again when the request resolves
                $("#text").prop("disabled", false);
                // Give focus to input
                $("#text").focus();
                // If chat is too long, automatically scrolls to bottom
            } else {
                // If inupt is not valid draw a red border and don't send the request
                $("#text").addClass("error");
            }
        });
    })

</script>